"use strict";(self.webpackChunkroky_wang=self.webpackChunkroky_wang||[]).push([[8025],{4999:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>d});var r=a(4848),s=a(8453);const o={title:"\u6210\u672c\u5206\u6790fadvisor"},t=void 0,i={id:"CloudNative/crane/fadvisor",title:"\u6210\u672c\u5206\u6790fadvisor",description:"Fadvisor: FinOps Advisor\uff0c\u53ef\u4ee5\u91c7\u96c6\u5bf9\u5e94\u96c6\u7fa4\u6210\u672c\u6570\u636e\uff0c\u7528\u6237crane\u7684\u6210\u672c\u53ef\u89c6\u5316\u548c\u4f18\u5316\uff0c\u76ee\u524d\u5b9e\u73b0\u817e\u8baf\u4e91tke\u7684\u6210\u672c\u91c7\u96c6\u80fd\u529b\u3002",source:"@site/docs/CloudNative/crane/fadvisor.md",sourceDirName:"CloudNative/crane",slug:"/CloudNative/crane/fadvisor",permalink:"/docs/CloudNative/crane/fadvisor",draft:!1,unlisted:!1,editUrl:"https://github.com/wxytjustb/rokywang/tree/main/docs/CloudNative/crane/fadvisor.md",tags:[],version:"current",frontMatter:{title:"\u6210\u672c\u5206\u6790fadvisor"},sidebar:"tutorialSidebar",previous:{title:"Crane",permalink:"/docs/category/crane"},next:{title:"cert-manager",permalink:"/docs/CloudNative/cert-manager"}},c={},d=[{value:"\u90e8\u7f72grafana",id:"\u90e8\u7f72grafana",level:3},{value:"\u90e8\u7f72fadvisor",id:"\u90e8\u7f72fadvisor",level:3},{value:"prometheus\u91c7\u96c6",id:"prometheus\u91c7\u96c6",level:3}];function l(e){const n={a:"a",code:"code",h3:"h3",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Fadvisor: FinOps Advisor\uff0c\u53ef\u4ee5\u91c7\u96c6\u5bf9\u5e94\u96c6\u7fa4\u6210\u672c\u6570\u636e\uff0c\u7528\u6237crane\u7684\u6210\u672c\u53ef\u89c6\u5316\u548c\u4f18\u5316\uff0c\u76ee\u524d\u5b9e\u73b0\u817e\u8baf\u4e91tke\u7684\u6210\u672c\u91c7\u96c6\u80fd\u529b\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.com/gocrane/fadvisor",children:"https://github.com/gocrane/fadvisor"})}),"\n",(0,r.jsxs)(n.p,{children:["\u57fa\u4e8ekubekey\u90e8\u7f72\u597d\u7684\u591a\u8282\u70b9\u96c6\u7fa4\u8fdb\u884c\u90e8\u7f72\uff0c\u7531\u4e8ekubersphere\u81ea\u5e26prometheus\uff0c\u4f7f\u7528\u96c6\u6210\u73b0\u6709\u76d1\u63a7\u7cfb\u7edf\u65b9\u5f0f\uff08",(0,r.jsx)(n.a,{href:"https://github.com/gocrane/fadvisor#integrated-with-existing-monitoring-components%EF%BC%89",children:"https://github.com/gocrane/fadvisor#integrated-with-existing-monitoring-components\uff09"})," \u90e8\u7f72\u5373\u53ef\uff0cgrafana\u9700\u8981\u5355\u72ec\u90e8\u7f72\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u90e8\u7f72grafana",children:"\u90e8\u7f72grafana"}),"\n",(0,r.jsx)(n.p,{children:"granfa\u4f7f\u7528helm\u5b89\u88c5\uff0c\u9700\u8981\u7f16\u8f91override_values.yaml\u9ed8\u8ba4\u6570\u636e\u6e90\u914d\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"wget https://raw.githubusercontent.com/gocrane/helm-charts/main/integration/grafana/override_values.yaml\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"## Configure grafana datasources\n## ref: http://docs.grafana.org/administration/provisioning/#datasources\n##\ndatasources:\n  datasources.yaml:\n    apiVersion: 1\n    datasources:\n      - name: Prometheus\n        type: prometheus\n        #url: http://prometheus-server.crane-system.svc.cluster.local:8080 \u9700\u8981\u66f4\u6362\u6210kubersphere monitor\u81ea\u5e26\u7684\u6570\u636e\u6e90\n        url: http://prometheus-k8s.kubesphere-monitoring-system.svc.cluster.local:9090\n        access: proxy\n        isDefault: true\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"helm repo add grafana https://grafana.github.io/helm-charts\nhelm upgrade --install grafana -f ./override_values.yaml -n crane-system --create-namespace grafana/grafana\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u67e5\u770bgrafana\u5bc6\u7801\uff0c\u7528\u6237\u540d\u548c\u5bc6\u7801\u901a\u5e38\u90fd\u662fadmin"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'kubectl get secret --namespace crane-system grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u672c\u5730\u6620\u5c04grafana\u8bbf\u95ee\u7aef\u53e3"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'export POD_NAME=$(kubectl get pods --namespace crane-system -l "app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana" -o jsonpath="{.items[0].metadata.name}")\nkubectl --namespace crane-system port-forward $POD_NAME 3000\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"http://127.0.0.1:3000",children:"http://127.0.0.1:3000"})," \u5373\u53ef\u8bbf\u95eegrafana\u4e86"]}),"\n",(0,r.jsx)(n.h3,{id:"\u90e8\u7f72fadvisor",children:"\u90e8\u7f72fadvisor"}),"\n",(0,r.jsx)(n.p,{children:"\u90e8\u7f72fadvisor"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"helm repo add crane https://gocrane.github.io/helm-charts\nhelm install fadvisor -n crane-system --create-namespace crane/fadvisor\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u672c\u5730\u521b\u5efa\u914d\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",metastring:'title="config.ini"',children:"[credentials]\nclusterId={your cluster id}\nappId=app1\nsecretId={your cloud provider credential secret id}\nsecretKey={your cloud provider credential secret key}\n[clientProfile]\ndefaultLimit=100\ndefaultLanguage=zh-CN\ndefaultTimeoutSeconds=10\nregion={your cluster region, such as ap-beijing\u3001ap-shanghai\u3001ap-guangzhou\u3001ap-shenzhen and so on, you can find region name in your cloud provider console}\ndomainSuffix=internal.tencentcloudapi.com\nscheme=\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u9605\u8bfb\u6e90\u7801\u770b\u51fa\uff0cclusterId\u548cappId\u6ca1\u6709\u4f7f\u7528\uff0c\u53ef\u4e0d\u586b\uff0c\u53ef\u4ee5\u4f7f\u7528secretId\u548csecretKey"}),"\n",(0,r.jsx)(n.p,{children:"\u66f4\u6539\u5b8c\u53c2\u6570\u4e4b\u540e\u8f6c\u4e3abase64\u7f16\u7801"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"cat config.ini | base64\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u7f16\u8f91fadvisor secret\uff0c\u5c06config\u5185\u5bb9\u66ff\u6362\u5373\u53ef"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"k edit secrets fadvisor -n crane-system\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u7f16\u8f91\u540efadvisor\u91cc\u6302\u8f7d/etc/cloud/config\u7684\u5185\u5bb9\u53d8\u4e86\uff0c\u9700\u8981\u5220\u6389pod\u91cd\u542f\u4e00\u4e0b\u751f\u6548"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"k delete pod fadvisor-5d69776545-gpw65 -n crane-system\n"})}),"\n",(0,r.jsx)(n.h3,{id:"prometheus\u91c7\u96c6",children:"prometheus\u91c7\u96c6"}),"\n",(0,r.jsx)(n.p,{children:"\u67e5\u770bprometheus\u4fe1\u606f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# k get pod -n kubesphere-monitoring-system\nNAME                                               READY   STATUS    RESTARTS   AGE\nalertmanager-main-0                                2/2     Running   0          146d\nalertmanager-main-1                                2/2     Running   0          146d\nalertmanager-main-2                                2/2     Running   0          134d\nkube-state-metrics-59758cbc95-5sffx                3/3     Running   0          146d\nnode-exporter-78zp8                                2/2     Running   0          146d\nnode-exporter-kwk59                                2/2     Running   4          146d\nnode-exporter-l7x6d                                2/2     Running   4          146d\nnode-exporter-phd4j                                2/2     Running   0          146d\nnotification-manager-deployment-54c787dd6d-dv2pb   2/2     Running   0          146d\nnotification-manager-deployment-54c787dd6d-zm46c   2/2     Running   0          146d\nnotification-manager-operator-58fb9784c8-g54w9     2/2     Running   0          146d\nprometheus-k8s-0                                   2/2     Running   1          146d\nprometheus-k8s-1                                   2/2     Running   1          134d\nprometheus-k8s-2                                   2/2     Running   1          146d\nprometheus-operator-5c5db79546-pkr77               2/2     Running   0          146d\n"})}),"\n",(0,r.jsx)(n.p,{children:"kubersphere\u4f7f\u7528prometheus-operator\u90e8\u7f72\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528ServiceMonitor\u65b9\u5f0f\u90e8\u7f72"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: fadvisor\n  namespace: crane-system\n# \u63cf\u8ff0\u6293\u53d6\u76ee\u6807 Pod \u7684\u9009\u53d6\u53ca\u6293\u53d6\u4efb\u52a1\u7684\u914d\u7f6e\nspec:\n  endpoints:\n  - interval: 5m\n    port: http\n    path: /metrics\n    honorLabels: true\n  namespaceSelector:\n    matchNames:\n      - crane-system\n  selector:\n    matchLabels:\n      app.kubernetes.io/instance: fadvisor\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u521b\u5efarecord rules, \u6bcf\u5c0f\u65f6\u6e05\u6d17\u4e00\u4e0b\u6570\u636e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  name: cost-rules\n  \nspec:\n  groups:\n    - name: costs.rules\n      interval: 3600s\n      rules:\n        - expr: |\n            sum(label_replace(irate(container_cpu_usage_seconds_total{container!="POD", container!="",image!=""}[1h]), "node", "$1", "instance",  "(.*)")) by (container, pod, node, namespace) * on (node) group_left() avg(avg_over_time(node_cpu_hourly_cost[1h])) by (node)\n          record: namespace:container_cpu_usage_costs_hourly:sum_rate\n        - expr: |\n            sum(label_replace(avg_over_time(container_memory_working_set_bytes{container!="POD",container!="",image!=""}[1h]), "node", "$1", "instance",  "(.*)")) by (container, pod, node, namespace) / 1024.0 / 1024.0 / 1024.0 * on (node) group_left() avg(avg_over_time(node_ram_hourly_cost[1h])) by (node)\n          record: namespace:container_memory_usage_costs_hourly:sum_rate\n        - expr: |\n            avg(avg_over_time(node_cpu_hourly_cost[1h])) by (node)\n          record: node:node_cpu_hourly_cost:avg\n        - expr: |\n            avg(avg_over_time(node_ram_hourly_cost[1h])) by (node)\n          record: node:node_ram_hourly_cost:avg\n        - expr: |\n            avg(avg_over_time(node_total_hourly_cost[1h])) by (node)\n          record: node:node_total_hourly_cost:avg\n'})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>t,x:()=>i});var r=a(6540);const s={},o=r.createContext(s);function t(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);