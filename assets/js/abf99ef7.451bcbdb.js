"use strict";(self.webpackChunkroky_wang=self.webpackChunkroky_wang||[]).push([[2678],{3198:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>l,toc:()=>o});var i=s(4848),t=s(8453);const a={},c=void 0,l={id:"MiddleWare/keycloak",title:"keycloak",description:"keycloak",source:"@site/docs/MiddleWare/keycloak.md",sourceDirName:"MiddleWare",slug:"/MiddleWare/keycloak",permalink:"/docs/MiddleWare/keycloak",draft:!1,unlisted:!1,editUrl:"https://github.com/wxytjustb/rokywang/tree/main/docs/MiddleWare/keycloak.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Kafka",permalink:"/docs/MiddleWare/kafka"},next:{title:"Minio",permalink:"/docs/MiddleWare/minio"}},r={},o=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"realm",id:"realm",level:5},{value:"\u5feb\u901f\u5f00\u59cb",id:"\u5feb\u901f\u5f00\u59cb",level:2},{value:"\u51c6\u5907\u5de5\u4f5c",id:"\u51c6\u5907\u5de5\u4f5c",level:3},{value:"SPA\u5e94\u7528\u96c6\u6210",id:"spa\u5e94\u7528\u96c6\u6210",level:3},{value:"apisix\u96c6\u6210",id:"apisix\u96c6\u6210",level:3},{value:"\u751f\u4ea7\u73af\u5883\u914d\u7f6e",id:"\u751f\u4ea7\u73af\u5883\u914d\u7f6e",level:2},{value:"\u81ea\u5b9a\u4e49\u4e3b\u9898\u5f00\u53d1",id:"\u81ea\u5b9a\u4e49\u4e3b\u9898\u5f00\u53d1",level:2},{value:"\u66f4\u591a\u5e94\u7528",id:"\u66f4\u591a\u5e94\u7528",level:2},{value:"\u5982\u4f55\u5f00\u542f\u591a\u8bed\u8a00",id:"\u5982\u4f55\u5f00\u542f\u591a\u8bed\u8a00",level:4}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"keycloak"}),"\n",(0,i.jsx)(n.h2,{id:"\u524d\u8a00",children:"\u524d\u8a00"}),"\n",(0,i.jsxs)(n.p,{children:["Keycloak\u662f\u4e00\u79cd\u9762\u5411\u73b0\u4ee3\u5e94\u7528\u548c\u670d\u52a1\u7684\u5f00\u6e90IAM\uff08\u8eab\u4efd\u8bc6\u522b\u4e0e\u8bbf\u95ee\u7ba1\u7406\uff09\u89e3\u51b3\u65b9\u6848\uff0cKeycloak\u63d0\u4f9b\u4e86\u5355\u70b9\u767b\u5f55\uff08SSO\uff09\u529f\u80fd\uff0c\u652f\u6301",(0,i.jsx)(n.code,{children:"OpenID Connect"}),"\u3001",(0,i.jsx)(n.code,{children:"OAuth 2.0"}),"\u3001",(0,i.jsx)(n.code,{children:"SAML 2.0"}),"\u6807\u51c6\u534f\u8bae\uff0c\u62e5\u6709\u7b80\u5355\u6613\u7528\u7684\u7ba1\u7406\u63a7\u5236\u53f0\uff0c\u5e76\u63d0\u4f9b\u5bf9LDAP\u3001Active Directory\u4ee5\u53caGithub\u3001Google\u7b49\u793e\u4ea4\u8d26\u53f7\u767b\u5f55\u7684\u652f\u6301\uff0c\u505a\u5230\u4e86\u975e\u5e38\u7b80\u5355\u7684\u5f00\u7bb1\u5373\u7528\u3002"]}),"\n",(0,i.jsx)(n.h5,{id:"realm",children:"realm"}),"\n",(0,i.jsx)(n.p,{children:"realm\u662f\u6700\u5c0f\u9879\u76ee\u5355\u5143\uff0c\u6709\u72ec\u7acb\u7684\u8d44\u6e90\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u5728Keycloak\u4e2d\uff0cAccess Type\u5206\u4e3a\u4e09\u79cd\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Confidential"}),"\uff1a\u7528\u4e8e\u9700\u8981\u8fdb\u884c\u6d4f\u89c8\u5668\u767b\u5f55\u7684\u5e94\u7528\uff0c\u5ba2\u6237\u7aef\u4f1a\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"client secret"})," \u83b7\u53d6 ",(0,i.jsx)(n.code,{children:"access token"})," \uff0c\u591a\u7528\u4e8e\u670d\u52a1\u5668\u6e32\u67d3\u7684 Web \u7cfb\u7edf\u4e2d\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Public"}),": \u9488\u5bf9\u9700\u8981\u8fdb\u884c\u6d4f\u89c8\u5668\u767b\u5f55\u7684\u5e94\u7528\uff0c\u591a\u7528\u4e8e\u4f7f\u7528vue\u548creact\u5b9e\u73b0\u7684\u524d\u7aef\u9879\u76ee\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Bearer-only"}),": \u5bf9\u4e8e\u4e0d\u9700\u8981\u6d4f\u89c8\u5668\u767b\u5f55\u7684\u5e94\u7528\uff0c\u53ea\u5141\u8bb8\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"bearer token"})," \u8bbf\u95ee\uff0c\u591a\u7528\u4e8e RESTful API \u573a\u666f\u3002"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u5feb\u901f\u5f00\u59cb",children:"\u5feb\u901f\u5f00\u59cb"}),"\n",(0,i.jsx)(n.h3,{id:"\u51c6\u5907\u5de5\u4f5c",children:"\u51c6\u5907\u5de5\u4f5c"}),"\n",(0,i.jsx)(n.p,{children:"\u90e8\u7f72dev\u7248"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"docker run -d --name keycloak -p 18080:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak:23.0.0 start-dev\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u8fdb\u5165\u540e\u53f0\u521b\u5efaquickstart realm"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"image-20240307164132847",src:s(2506).A+"",width:"1862",height:"777"})}),"\n",(0,i.jsx)(n.p,{children:"\u521b\u5efa\u7528\u6237"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"image-20240308164257966",src:s(4033).A+"",width:"2772",height:"1526"})}),"\n",(0,i.jsx)(n.p,{children:"\u7528\u6237\u884c\u4e3a\u53ef\u4ee5\u914d\u7f6e\u4e00\u4e9b\u4fe1\u606f\uff0c\u4f8b\u5982\u7ed1\u5b9aOTP\u4e4b\u7c7b\u7684\u64cd\u4f5c\uff0c\u6d4b\u8bd5\u53ef\u4ee5\u9ed8\u8ba4\u4e0d\u9009\u62e9"}),"\n",(0,i.jsx)(n.h3,{id:"spa\u5e94\u7528\u96c6\u6210",children:"SPA\u5e94\u7528\u96c6\u6210"}),"\n",(0,i.jsx)(n.p,{children:"\u6309\u4ee5\u4e0b\u6587\u6863\u8fd0\u884cspa demo"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/keycloak/keycloak-quickstarts/tree/latest/js/spa",children:"https://github.com/keycloak/keycloak-quickstarts/tree/latest/js/spa"})}),"\n",(0,i.jsx)(n.p,{children:"\u8bbf\u95ee\u5982\u56fe\u6240\u793a"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"image-20240306164123833",src:s(3595).A+"",width:"594",height:"259"})}),"\n",(0,i.jsx)(n.p,{children:"js\u521d\u59cb\u5316\u5ba2\u6237\u7aef"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'  const keycloak = new Keycloak();\n  await keycloak.init({ scope: "phone", onLoad: "login-required" });\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u4f7f\u7528userinfo endpoints\u6765\u9a8c\u8bc1token"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'curl http://127.0.0.1:18080/realms/quickstart/protocol/openid-connect/userinfo -H "Authorization: Bearer ${access_token}" -H "Content-Type: application/json"\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u8fd4\u56de"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n    "sub": "7e72c240-ee74-439d-948e-6e3e1080bc1b",\n    "email_verified": false,\n    "preferred_username": "admin",\n    "email": "admin@test.com"\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"apisix\u96c6\u6210",children:"apisix\u96c6\u6210"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"image-20240307165324141",src:s(5741).A+"",width:"1800",height:"961"})}),"\n",(0,i.jsx)(n.h2,{id:"\u751f\u4ea7\u73af\u5883\u914d\u7f6e",children:"\u751f\u4ea7\u73af\u5883\u914d\u7f6e"}),"\n",(0,i.jsx)(n.p,{children:"\u4f7f\u7528docker-compose\u6765\u90e8\u7f72"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'version: "3"\nservices:\n  keycloak:\n    image: keycloak/keycloak:23.0.0\n    command:\n      - start\n      - --hostname=auth.xxx.com\n      - --http-enabled=true\n      - --https-port=443\n      - --hostname-strict-backchannel=true\n      - --hostname-admin-url=https://auth-dashboard.xxx.com\n    environment:\n      KC_DB: mysql\n      KC_DB_URL_HOST: mysql-host\n      KC_DB_PASSWORD: 123456\n      KC_DB_USERNAME: root\n      KC_DB_SCHEMA: keycloak\n      KEYCLOAK_ADMIN: admin\n      KEYCLOAK_ADMIN_PASSWORD: admin\n    ports:\n      - "28080:8080"\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u81ea\u5b9a\u4e49\u4e3b\u9898\u5f00\u53d1",children:"\u81ea\u5b9a\u4e49\u4e3b\u9898\u5f00\u53d1"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_development/#_themes",children:"https://www.keycloak.org/docs/latest/server_development/#_themes"})}),"\n",(0,i.jsx)(n.h2,{id:"\u66f4\u591a\u5e94\u7528",children:"\u66f4\u591a\u5e94\u7528"}),"\n",(0,i.jsx)(n.h4,{id:"\u5982\u4f55\u5f00\u542f\u591a\u8bed\u8a00",children:"\u5982\u4f55\u5f00\u542f\u591a\u8bed\u8a00"}),"\n",(0,i.jsx)(n.p,{children:"500\u62a5\u9519"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shel",children:'2024/03/08 09:10:28 [error] 50#50: *3128451 [lua] openidc.lua:1098: authenticate(): unhandled request to the redirect_uri: /, client: 1.2.3.4, server: _, request: "GET / HTTP/2.0", host: "xxx.xxx.com"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u6839\u636e\u62a5\u9519\u4fe1\u606f\u67e5\u770b\u6e90\u7801",(0,i.jsx)(n.a,{href:"https://github.com/zmartzone/lua-resty-openidc/blob/v1.7.6/lib/resty/openidc.lua",children:"https://github.com/zmartzone/lua-resty-openidc/blob/v1.7.6/lib/resty/openidc.lua"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"image-20240308174433946",src:s(8e3).A+"",width:"986",height:"394"})}),"\n",(0,i.jsx)(n.p,{children:"redirect_url\u6bd4\u8f83\u7279\u6b8a\uff0c\u8bbf\u95ee\u8fd9\u4e2aurl\u65f6\u5fc5\u987b\u5e26\u4e0acode\u6216\u8005state\u53c2\u6570"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["\u30101\u301110 \u5206\u949f\u7406\u89e3\u4ec0\u4e48\u662f OpenID Connect\uff08OIDC\uff09\u534f\u8bae ",(0,i.jsx)(n.a,{href:"https://deepzz.com/post/what-is-oidc-protocol.html",children:"https://deepzz.com/post/what-is-oidc-protocol.html"})]}),"\n",(0,i.jsxs)(n.p,{children:["\u30102\u3011js\u5ba2\u6237\u7aef\u6587\u6863 ",(0,i.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/securing_apps/index.html#_javascript_adapter",children:"https://www.keycloak.org/docs/latest/securing_apps/index.html#_javascript_adapter"})]}),"\n",(0,i.jsxs)(n.p,{children:["\u30103\u3011Use Keycloak with API Gateway to secure APIs ",(0,i.jsx)(n.a,{href:"https://apisix.apache.org/blog/2022/07/06/use-keycloak-with-api-gateway-to-secure-apis/",children:"https://apisix.apache.org/blog/2022/07/06/use-keycloak-with-api-gateway-to-secure-apis/"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},2506:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/image-20240307164132847-185ea3fe7b8c19860da8dd9056b2c4f4.png"},5741:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/image-20240307165324141-c2cb56ccb97e549ae3aec13e5521e45e.png"},4033:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/image-20240308164257966-4813d4764ab030abf1f03134a2177a8f.png"},8e3:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/image-20240308174433946-7cc15f1ae663ef7f2c259d76beebda55.png"},3595:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/keycloak-1-749fc00927b8e04ba05159c0f5837e95.png"},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>l});var i=s(6540);const t={},a=i.createContext(t);function c(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);